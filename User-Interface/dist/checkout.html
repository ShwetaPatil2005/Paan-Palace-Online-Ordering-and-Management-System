<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout - Paan Palace</title>
  <style>
    :root {
      --primary-color: #8B0000;
      --secondary-color: #228B22;
      --accent-color: #FFD700;
      --light-color: #FFF8DC;
      --dark-color: #5a2d0c;
      --text-color: #333;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f9f5f0;
      color: var(--text-color);
      line-height: 1.7;
      padding: 20px;
      background-image: radial-gradient(circle at 10% 20%, var(--light-color) 0%, #f5f5f5 90%);
      min-height: 100vh;
    }

    .container {
      max-width: 700px;
      margin: 30px auto;
      background: white;
      padding: 40px;
      box-shadow: var(--shadow);
      border-radius: 15px;
      border: 1px solid rgba(0,0,0,0.05);
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.5rem;
      position: relative;
      padding-bottom: 15px;
    }

    h1::after {
      content: '';
      display: block;
      width: 80px;
      height: 4px;
      background: var(--accent-color);
      margin: 15px auto 0;
      border-radius: 2px;
    }

    .summary {
      padding: 20px;
      background: rgba(255, 248, 220, 0.3);
      border-radius: 10px;
      margin: 25px 0;
      border: 1px dashed var(--accent-color);
    }

    .summary p {
      font-size: 1.1rem;
      margin: 15px 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
    }

    .summary p:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 1.2rem;
      color: var(--primary-color);
    }

    .summary strong {
      color: var(--dark-color);
      min-width: 150px;
      display: inline-block;
    }

    .cart-items {
      margin-bottom: 20px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px dashed #ddd;
      font-size: 1rem;
      color: var(--text-color);
    }

    .cart-item:last-child {
      border-bottom: none;
    }

    .cart-item span:first-child {
      flex: 1;
    }

    .cart-item span:last-child {
      font-weight: 600;
      color: var(--primary-color);
    }

    .btn {
      padding: 15px 25px;
      font-size: 1.1rem;
      margin: 30px auto 10px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      display: block;
      width: 100%;
      max-width: 300px;
      font-weight: 600;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background-color: var(--primary-color);
      color: white;
      box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
    }

    .btn-primary:hover {
      background-color: #6b0000;
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(139, 0, 0, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-primary::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -60%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(30deg);
      transition: all 0.3s;
    }

    .btn-primary:hover::after {
      left: 100%;
    }

    @media (max-width: 768px) {
      .container {
        padding: 25px;
        margin: 20px auto;
      }

      h1 {
        font-size: 2rem;
      }

      .summary p, .cart-item {
        flex-direction: column;
      }

      .summary strong {
        margin-bottom: 5px;
      }

      .cart-item span {
        margin-bottom: 5px;
      }

      .btn {
        max-width: 100%;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Order Summary</h1>
    <div class="summary">
      <p><strong>Name:</strong> <span id="summaryName"></span></p>
      <p><strong>Email:</strong> <span id="summaryEmail"></span></p>
      <p><strong>Delivery Address:</strong> <span id="summaryAddress"></span></p>
      <div class="cart-items" id="cartItems"></div>
      <p><strong>Total Quantity:</strong> <span id="summaryQuantity"></span></p>
      <p><strong>Total Price:</strong> ‚Çπ<span id="summaryTotal"></span></p>
    </div>
    <button id="confirmBtn" class="btn btn-primary">Confirm Order</button>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const data = JSON.parse(localStorage.getItem('checkoutData'));
    const token = localStorage.getItem('jwtToken');

    if (!data || !token) {
      alert('‚ùó No order found. Please go back and try again.');
      window.location.href = 'products.html';
      return;
    }

    // Safe JWT parsing
    let email = "Unknown";
    try {
      const payload = JSON.parse(atob(token.split('.')[1]));
      email = payload.sub || payload.email || "Unknown";
    } catch (e) {
      console.warn("‚ö†Ô∏è Failed to parse token:", e);
    }

    // Fill in customer info
    document.getElementById('summaryName').textContent = data.customerName || 'N/A';
    document.getElementById('summaryEmail').textContent = email;
    document.getElementById('summaryAddress').textContent = data.address || 'N/A';

    // Fetch and display cart items
    const cartItemsContainer = document.getElementById('cartItems');
    let totalQuantity = 0;

    try {
      if (!Array.isArray(data.items) || data.items.length === 0) {
        throw new Error('Invalid cart data: Missing or invalid items');
      }

      // Fetch product details and display
      for (const item of data.items) {
        const response = await fetch(`http://localhost:8080/api/products/${item.productId}`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errText = await response.text();
          throw new Error(`Error fetching product ${item.productId}: ${response.status} - ${errText}`);
        }

        const product = await response.json();
        totalQuantity += item.quantity;

        // Create cart item element
        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          <span>${product.name} (x${item.quantity})</span>
          <span>‚Çπ${(product.price * item.quantity).toFixed(2)}</span>
        `;
        cartItemsContainer.appendChild(cartItem);
      }

      // Update total quantity and price
      document.getElementById('summaryQuantity').textContent = totalQuantity;
      document.getElementById('summaryTotal').textContent = data.totalPrice.toFixed(2);

      // Confirm order button action
      const confirmBtn = document.getElementById('confirmBtn');
      confirmBtn.addEventListener('click', () => {
        if (!data.items.length) {
          alert('‚ùó No products found in order. Please go back and try again.');
          window.location.href = 'products.html';
          return;
        }

        confirmBtn.disabled = true;
        confirmBtn.textContent = "Processing...";

        // Prepare order data with items
        const orderData = {
          customerName: data.customerName,
          customerEmail: email,
          address: data.address,
          items: data.items,
          totalPrice: data.totalPrice,
          quantity: totalQuantity
        };
        console.log('Order Data Sent to Backend:', orderData);

        fetch('http://localhost:8080/api/orders', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(orderData)
        })
        .then(response => {
          console.log('Response Status:', response.status);
          console.log('Response Headers:', response.headers);
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error(`HTTP error! Status: ${response.status}, Message: ${text}`);
            });
          }
          return response.json();
        })
        .then(result => {
          console.log('API Response:', result);
          if (result) {
            alert("üéâ Your order has been confirmed! Thank you for choosing Paan Palace!");
            localStorage.removeItem('checkoutData');
            localStorage.removeItem('cart');
            setTimeout(() => {
              window.location.href = 'products.html';
            }, 2000);
          } else {
            alert("‚ö†Ô∏è Order was not successful. Please try again.");
          }
        })
        .catch(err => {
          console.error("‚ùå Error placing order:", err);
          alert("‚ö†Ô∏è Something went wrong! Please try again. Error: " + err.message);
        })
        .finally(() => {
          confirmBtn.disabled = false;
          confirmBtn.textContent = "Confirm Order";
        });
      });

    } catch (error) {
      console.error('‚ùå Error loading cart items:', error);
      alert('‚ùå Error loading cart items: ' + error.message);
      cartItemsContainer.innerHTML = '<p>No items in cart.</p>';
      document.getElementById('summaryQuantity').textContent = '0';
      document.getElementById('summaryTotal').textContent = '0';
    }
  });
  </script>
</body>
</html>